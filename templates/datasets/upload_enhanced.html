{% extends 'base.html' %}
{% load static %}

{% block title %}Enhanced Upload - Data Quality Watchtower{% endblock %}

{% block extra_css %}
<link href="{% static 'css/upload_enhanced.css' %}" rel="stylesheet">
<style>
    .upload-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .upload-zone {
        background: rgba(25, 25, 45, 0.85);
        backdrop-filter: blur(20px);
        border: 2px dashed rgba(102, 126, 234, 0.4);
        border-radius: 24px;
        padding: 4rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .upload-zone::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s;
    }

    .upload-zone:hover {
        border-color: rgba(102, 126, 234, 0.8);
        transform: translateY(-4px);
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.2);
    }

    .upload-zone:hover::before {
        opacity: 1;
    }

    .upload-zone.drag-over {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
        transform: scale(1.02);
    }

    .upload-icon-wrapper {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 2rem;
        position: relative;
    }

    .upload-icon-wrapper i {
        font-size: 2.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .upload-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: white;
    }

    .upload-subtitle {
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 2rem;
    }

    .upload-formats {
        display: inline-flex;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .name-input-section {
        background: rgba(25, 25, 45, 0.85);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .analysis-card {
        background: rgba(25, 25, 45, 0.85);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
        margin-top: 2rem;
    }

    .analysis-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem;
    }

    .analysis-body {
        padding: 2rem;
    }

    .progress-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        height: 12px;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #38ef7d 100%);
        background-size: 200% 100%;
        border-radius: 12px;
        transition: width 0.3s ease;
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.3s;
    }

    .stat-card:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-4px);
    }

    .stat-card .number {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .stat-card .label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.5rem;
    }

    .feature-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        transition: all 0.3s;
    }

    .feature-item:hover {
        background: rgba(102, 126, 234, 0.1);
        transform: translateX(4px);
    }

    .feature-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #667eea;
    }

    .feature-text h6 {
        margin: 0;
        font-weight: 600;
        color: white;
    }

    .feature-text small {
        color: rgba(255, 255, 255, 0.5);
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .feature-list {
            grid-template-columns: 1fr;
        }

        .upload-zone {
            padding: 2rem 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="page-header">
        <h1><i class="fas fa-magic me-3"></i>Enhanced Upload</h1>
        <p>Upload and analyze your dataset with AI-powered profiling</p>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="upload-container">
                <!-- Dataset Name -->
                <div class="name-input-section">
                    <label class="form-label" for="dataset-name">
                        <i class="fas fa-tag me-2"></i>Dataset Name
                    </label>
                    <input type="text" class="form-control form-control-lg" id="dataset-name"
                        placeholder="Enter a unique name for your dataset" required>
                </div>

                <!-- Upload Zone -->
                <div class="upload-zone" id="drop-zone">
                    <input type="file" id="file-upload" accept=".csv" style="display: none;">

                    <div class="upload-icon-wrapper">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>

                    <h3 class="upload-title">Drop your CSV file here</h3>
                    <p class="upload-subtitle">or click to browse from your computer</p>

                    <div class="upload-formats">
                        <i class="fas fa-file-csv"></i>
                        <span>CSV files up to 50MB</span>
                    </div>
                </div>

                <!-- File Preview -->
                <div id="file-preview" style="display: none;"></div>

                <!-- Action Buttons -->
                <div id="action-buttons" class="text-center mt-4" style="display: none;">
                    <a href="{% url 'datasets:dataset_list' %}" class="btn btn-outline-light btn-lg me-2">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="button" class="btn btn-primary btn-lg" id="upload-and-analyze-btn">
                        <i class="fas fa-play me-2"></i>Analyze Dataset
                    </button>
                </div>

                <!-- Analysis Results -->
                <div class="analysis-card" id="analysis-results" style="display: none;">
                    <div class="analysis-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Analysis Results</h5>
                    </div>
                    <div class="analysis-body">
                        <div class="progress-container">
                            <div class="progress-fill" id="analysis-progress" style="width: 0%;"></div>
                        </div>
                        <div id="analysis-content">
                            <p class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Analyzing...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Features Card -->
            <div class="card mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-sparkles me-2"></i>Smart Features</h6>
                </div>
                <div class="card-body">
                    <div class="feature-list">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="feature-text">
                                <h6>Privacy First</h6>
                                <small>Processed locally</small>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="feature-text">
                                <h6>Auto Profiling</h6>
                                <small>Smart analysis</small>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="feature-text">
                                <h6>Rule Generation</h6>
                                <small>Auto-create rules</small>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="feature-text">
                                <h6>Instant Results</h6>
                                <small>Real-time feedback</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- What We Detect -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-search me-2"></i>What We Detect</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Null & duplicate values
                        </li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Data type inference</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Email/Phone/URL patterns
                        </li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Statistical summaries</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Quality score calculation
                        </li>
                        <li class="mb-0"><i class="fas fa-check-circle text-success me-2"></i>Validation rule
                            suggestions</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="{% static 'js/drag_drop.js' %}"></script>
<script src="{% static 'js/dataset_profiler.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-upload');
        const datasetName = document.getElementById('dataset-name');
        const analysisResults = document.getElementById('analysis-results');
        const actionButtons = document.getElementById('action-buttons');

        let selectedFile = null;
        let profilerInstance = null;

        // Initialize drag-and-drop
        const uploader = new DragDropUploader('drop-zone', 'file-upload', {
            acceptedTypes: ['text/csv', '.csv'],
            maxSize: 50 * 1024 * 1024,
            onFileSelected: function (file) {
                selectedFile = file;
                createFilePreview(file, 'file-preview');
                actionButtons.style.display = 'block';
            },
            onError: function (error) {
                alert(error);
            }
        });

        // Analyze button click
        document.getElementById('upload-and-analyze-btn').addEventListener('click', function () {
            if (!datasetName.value) {
                alert('Please enter a dataset name');
                datasetName.focus();
                return;
            }
            if (!selectedFile) {
                alert('Please select a file');
                return;
            }
            analyzeDataset(selectedFile, datasetName.value);
        });

        function analyzeDataset(file, name) {
            analysisResults.style.display = 'block';
            analysisResults.scrollIntoView({ behavior: 'smooth' });

            if (!profilerInstance) {
                profilerInstance = new DatasetProfiler();
            }

            updateProgress(10, 'Parsing CSV file...');

            profilerInstance.parseCSV(file)
                .then(() => {
                    updateProgress(40, 'Profiling dataset...');
                    const profile = profilerInstance.profileDataset();

                    updateProgress(70, 'Generating rules...');
                    const rules = profilerInstance.generateRules();

                    updateProgress(90, 'Running validation...');
                    const ruleResults = profilerInstance.executeRulesLocally();

                    updateProgress(100, 'Complete!');

                    displayResults(profile, rules, ruleResults, name);
                })
                .catch(error => {
                    console.error('Analysis error:', error);
                    document.getElementById('analysis-content').innerHTML =
                        '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ' + error.message + '</div>';
                });
        }

        function updateProgress(percentage, message) {
            document.getElementById('analysis-progress').style.width = percentage + '%';
            if (message) {
                document.getElementById('analysis-content').innerHTML =
                    '<p class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>' + message + '</p>';
            }
        }

        function displayResults(profile, rules, ruleResults, datasetName) {
            const qualityScore = profilerInstance.calculateQualityScore(ruleResults);

            document.getElementById('analysis-content').innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number">${profile.rowCount.toLocaleString()}</div>
                    <div class="label">Rows</div>
                </div>
                <div class="stat-card">
                    <div class="number">${profile.columnCount}</div>
                    <div class="label">Columns</div>
                </div>
                <div class="stat-card">
                    <div class="number">${rules.length}</div>
                    <div class="label">Rules</div>
                </div>
                <div class="stat-card">
                    <div class="number">${Math.round(qualityScore)}%</div>
                    <div class="label">Quality</div>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-success btn-lg" id="save-dataset-btn">
                    <i class="fas fa-save me-2"></i>Save Dataset & Rules
                </button>
            </div>
        `;

            document.getElementById('save-dataset-btn').addEventListener('click', function () {
                saveDatasetAndRules(profile, rules, datasetName, qualityScore);
            });
        }

        function saveDatasetAndRules(profile, rules, datasetName, qualityScore) {
            const saveBtn = document.getElementById('save-dataset-btn');
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            saveBtn.disabled = true;

            fetch('{% url "datasets:save_enhanced_dataset" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    dataset_name: datasetName,
                    profile: profile,
                    rules: rules,
                    quality_score: qualityScore
                })
            })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '{% url "users:login" %}?next=' + window.location.pathname;
                        throw new Error('Authentication required');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        window.location.href = '{% url "datasets:dataset_list" %}';
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                        saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Dataset & Rules';
                        saveBtn.disabled = false;
                    }
                })
                .catch(error => {
                    if (error.message !== 'Authentication required') {
                        console.error('Save error:', error);
                        alert('Error: ' + error.message);
                        saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Dataset & Rules';
                        saveBtn.disabled = false;
                    }
                });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
